<div class="container-fluid py-5 catalogue">
  <!-- Toast Notification -->
  <div 
    class="toast-notification position-fixed top-0 start-50 translate-middle-x mt-5" 
    [class.show]="showToast"
    [class.success]="toastType === 'success'"
    [class.error]="toastType === 'error'"
    [class.info]="toastType === 'info'"
    (click)="hideToast()"
    style="z-index: 9999;">
    <div class="toast-icon">
      <span *ngIf="toastType === 'success'">‚úì</span>
      <span *ngIf="toastType === 'error'">‚úï</span>
      <span *ngIf="toastType === 'info'">‚Ñπ</span>
    </div>
    <span class="toast-message">{{ toastMessage }}</span>
  </div>

  <!-- Header avec recherche -->
  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
    <div>
      <h1 class="mb-0">Catalogue</h1>
    </div>
    <div class="search-container">
      <div class="input-group" style="max-width: 300px;">
        <span class="input-group-text bg-transparent border-gold-subtle">
          <span>üîç</span>
        </span>
        <input 
          type="text" 
          class="form-control border-gold-subtle"
          [(ngModel)]="searchQuery"
          (keyup.enter)="onSearch()"
          placeholder="Rechercher...">
        <button class="btn btn-outline-secondary border-gold-subtle" *ngIf="searchQuery" (click)="clearSearch()">
          ‚úï
        </button>
      </div>
    </div>
  </div>

  <!-- Filtres compacts -->
  <div class="d-flex flex-wrap align-items-center gap-3 mb-4">
    <!-- Cat√©gories -->
    <div class="dropdown">
      <button 
        class="btn btn-filter dropdown-toggle" 
        type="button" 
        id="categoryDropdown" 
        data-bs-toggle="dropdown" 
        aria-expanded="false">
        {{ getCategoryDisplayName() }}
      </button>
      <ul class="dropdown-menu" aria-labelledby="categoryDropdown">
        <li *ngFor="let cat of categories">
          <a class="dropdown-item" 
             [class.active]="selectedCategory === cat.categoryId"
             (click)="selectedCategory = cat.categoryId; onCategoryChange()">
            {{ cat.displayName }}
          </a>
        </li>
      </ul>
    </div>

    <!-- Marque -->
    <div class="dropdown">
      <button 
        class="btn btn-filter dropdown-toggle" 
        type="button" 
        id="brandDropdown" 
        data-bs-toggle="dropdown" 
        aria-expanded="false">
        <span>üè∑Ô∏è</span> {{ selectedBrand || 'Marque' }}
      </button>
      <ul class="dropdown-menu" aria-labelledby="brandDropdown">
        <li>
          <a class="dropdown-item" 
             [class.active]="!selectedBrand"
             (click)="selectedBrand = ''; onFilterChange()">
            Toutes les marques
          </a>
        </li>
        <li><hr class="dropdown-divider"></li>
        <li *ngFor="let brand of availableBrands">
          <a class="dropdown-item" 
             [class.active]="selectedBrand === brand"
             (click)="selectedBrand = brand; onFilterChange()">
            {{ brand }}
          </a>
        </li>
      </ul>
    </div>

    <!-- Note -->
    <div class="dropdown">
      <button 
        class="btn btn-filter dropdown-toggle" 
        type="button" 
        id="ratingDropdown" 
        data-bs-toggle="dropdown" 
        aria-expanded="false">
        <span>‚≠ê</span> {{ getRatingDisplayName() }}
      </button>
      <ul class="dropdown-menu" aria-labelledby="ratingDropdown">
        <li>
          <a class="dropdown-item" 
             [class.active]="minRating === null"
             (click)="minRating = null; onFilterChange()">
            Toutes les notes
          </a>
        </li>
        <li><hr class="dropdown-divider"></li>
        <li>
          <a class="dropdown-item" 
             [class.active]="minRating === 4"
             (click)="minRating = 4; onFilterChange()">
            4 √©toiles et plus
          </a>
        </li>
        <li>
          <a class="dropdown-item" 
             [class.active]="minRating === 3"
             (click)="minRating = 3; onFilterChange()">
            3 √©toiles et plus
          </a>
        </li>
        <li>
          <a class="dropdown-item" 
             [class.active]="minRating === 2"
             (click)="minRating = 2; onFilterChange()">
            2 √©toiles et plus
          </a>
        </li>
        <li>
          <a class="dropdown-item" 
             [class.active]="minRating === 1"
             (click)="minRating = 1; onFilterChange()">
            1 √©toile et plus
          </a>
        </li>
      </ul>
    </div>

    <!-- Prix -->
    <div class="dropdown">
      <button 
        class="btn btn-filter dropdown-toggle" 
        type="button" 
        id="priceDropdown" 
        data-bs-toggle="dropdown" 
        aria-expanded="false">
        <span>üí∞</span> {{ getPriceDisplayName() }}
      </button>
      <div class="dropdown-menu p-3" aria-labelledby="priceDropdown" style="min-width: 250px;">
        <div class="mb-2">
          <label class="form-label small">Prix minimum</label>
          <input 
            type="number" 
            class="form-control form-control-sm"
            [(ngModel)]="minPrice"
            (change)="onFilterChange()"
            placeholder="Min"
            min="0">
        </div>
        <div class="mb-2">
          <label class="form-label small">Prix maximum</label>
          <input 
            type="number" 
            class="form-control form-control-sm"
            [(ngModel)]="maxPrice"
            (change)="onFilterChange()"
            placeholder="Max"
            min="0">
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-sm btn-outline-secondary flex-fill" (click)="minPrice = null; maxPrice = null; onFilterChange()">
            R√©initialiser
          </button>
        </div>
      </div>
    </div>

    <!-- Trier -->
    <div class="dropdown">
      <button 
        class="btn btn-filter dropdown-toggle" 
        type="button" 
        id="sortDropdown" 
        data-bs-toggle="dropdown" 
        aria-expanded="false">
        <span>‚áÖ</span> {{ getSortDisplayName() }}
      </button>
      <ul class="dropdown-menu" aria-labelledby="sortDropdown">
        <li>
          <a class="dropdown-item" 
             [class.active]="sortBy === 'none'"
             (click)="sortBy = 'none'; onFilterChange()">
            Aucun tri
          </a>
        </li>
        <li><hr class="dropdown-divider"></li>
        <li>
          <a class="dropdown-item" 
             [class.active]="sortBy === 'price-asc'"
             (click)="sortBy = 'price-asc'; onFilterChange()">
            Prix croissant
          </a>
        </li>
        <li>
          <a class="dropdown-item" 
             [class.active]="sortBy === 'price-desc'"
             (click)="sortBy = 'price-desc'; onFilterChange()">
            Prix d√©croissant
          </a>
        </li>
        <li>
          <a class="dropdown-item" 
             [class.active]="sortBy === 'rating-desc'"
             (click)="sortBy = 'rating-desc'; onFilterChange()">
            Meilleure note
          </a>
        </li>
        <li>
          <a class="dropdown-item" 
             [class.active]="sortBy === 'reviews-desc'"
             (click)="sortBy = 'reviews-desc'; onFilterChange()">
            Plus de commentaires
          </a>
        </li>
      </ul>
    </div>

    <!-- R√©initialiser -->
    <button 
      class="btn btn-filter ms-auto" 
      *ngIf="hasActiveFilters()" 
      (click)="resetFilters()">
      R√©initialiser
    </button>
  </div>

  <!-- R√©sultats -->
  <div class="d-flex justify-content-between align-items-center mb-4" *ngIf="!loading && filteredProducts.length > 0">
    <span *ngIf="searchQuery" class="text-muted-custom small">R√©sultats pour "{{ searchQuery }}"</span>
    <span class="text-muted-custom small ms-auto">{{ filteredProducts.length }} parfum{{ filteredProducts.length > 1 ? 's' : '' }}</span>
  </div>

  <!-- Loading -->
  <div class="text-center py-5" *ngIf="loading">
    <div class="spinner-border text-gold" role="status">
      <span class="visually-hidden">Chargement...</span>
    </div>
    <p class="mt-3 text-muted-custom">Chargement des parfums...</p>
  </div>

  <!-- Erreur -->
  <div class="alert alert-danger text-center" *ngIf="error && !loading">
    <p class="mb-3">{{ error }}</p>
    <button class="btn btn-outline-primary" (click)="loadProducts()">R√©essayer</button>
  </div>

  <!-- √âtat vide -->
  <div class="text-center py-5" *ngIf="!loading && !error && filteredProducts.length === 0">
    <p class="text-muted-custom mb-3">Aucun parfum trouv√©</p>
    <button class="btn btn-outline-primary" (click)="resetFilters(); clearSearch()">
      R√©initialiser les filtres
    </button>
  </div>

  <!-- Grille de produits -->
  <div class="row g-4 mb-5" *ngIf="!loading && filteredProducts.length > 0">
    <div class="col-lg-3 col-md-4 col-sm-6" *ngFor="let product of getPaginatedProducts()">
      <div class="card h-100 product-card" (click)="openProduct(product)">
        <!-- Badges -->
        <div class="position-absolute top-0 start-0 m-2 d-flex flex-column gap-1" style="z-index: 2;">
          <span class="badge bg-gold" *ngIf="product.currentSku.isNew">Nouveau</span>
          <span class="badge bg-amber" *ngIf="product.currentSku.isSephoraExclusive">Exclusif</span>
          <span class="badge" style="background: rgba(180, 80, 100, 0.9); color: var(--cream);" *ngIf="product.currentSku.isLimitedEdition">√âdition Limit√©e</span>
        </div>
        
        <!-- Bouton Favori -->
        <button 
          class="favorite-btn position-absolute top-0 end-0 m-2" 
          [class.active]="isFavorite(product.productId)"
          (click)="toggleFavorite($event, product)"
          [title]="isFavorite(product.productId) ? 'Retirer des favoris' : 'Ajouter aux favoris'">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
          </svg>
        </button>
        
        <!-- Image -->
        <div class="product-image">
          <img [src]="product.heroImage" [alt]="product.displayName" class="card-img-top" loading="lazy">
        </div>
        
        <!-- Info -->
        <div class="card-body d-flex flex-column">
          <p class="product-brand mb-1">{{ product.brandName }}</p>
          <h6 class="card-title product-name mb-2">{{ product.displayName }}</h6>
          
          <!-- Rating -->
          <div class="d-flex align-items-center gap-2 mb-2" *ngIf="product.rating">
            <div class="stars">
              <span *ngFor="let star of getStars(product.rating)" 
                    class="star" 
                    [class.full]="star === 'full'"
                    [class.half]="star === 'half'">‚òÖ</span>
            </div>
            <small class="text-gold fw-bold">{{ formatRating(product.rating) }}</small>
            <small class="text-muted-custom">({{ product.reviews }})</small>
          </div>
          
          <!-- Prix -->
          <p class="product-price mt-auto mb-0">{{ formatPrice(product.currentSku.listPrice) }}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Pagination -->
  <nav *ngIf="!loading && totalPages > 1 && filteredProducts.length > 0">
    <ul class="pagination justify-content-center">
      <li class="page-item" [class.disabled]="currentPage === 1">
        <a class="page-link" (click)="prevPage(); $event.preventDefault()" href="#" aria-label="Previous">
          <span aria-hidden="true">&laquo;</span>
        </a>
      </li>
      <li class="page-item" *ngFor="let page of getPageNumbers()" [class.active]="page === currentPage">
        <a class="page-link" (click)="goToPage(page); $event.preventDefault()" href="#">{{ page }}</a>
      </li>
      <li class="page-item" [class.disabled]="currentPage === totalPages">
        <a class="page-link" (click)="nextPage(); $event.preventDefault()" href="#" aria-label="Next">
          <span aria-hidden="true">&raquo;</span>
        </a>
      </li>
    </ul>
  </nav>
</div>
